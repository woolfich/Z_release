{
  "src/routes/+page.svelte": "<script lang=\"ts\">
    import ImportExport from '$lib/components/ImportExport.svelte';
    import WelderCalendarModal from '$lib/components/WelderCalendarModal.svelte'; // <-- 1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    import { onMount } from 'svelte';
    import { db, type Welder } from '$lib/db';
    import { base } from '$app/paths';

    let newWelderName = '';
    let welders: Welder[] = [];

    // --- 2. –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---
    let showWelderModal = false;
    let selectedWelder: Welder | null = null;
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û ---

    async function loadWelders() {
        welders = await db.welders.orderBy('name').toArray();
    }

    async function addWelder() {
        if (newWelderName.trim() === '') {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é!');
            return;
        }
        await db.welders.add({ name: newWelderName.trim() });
        newWelderName = '';
        await loadWelders();
    }

    // --- 3. –ù–û–í–û–ï: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è ---
    const LONG_PRESS_MS = 500; // 0.5 —Å–µ–∫—É–Ω–¥—ã
    const MOVE_CANCEL_PX = 10;

    type PressState = {
        timeoutId: number | null;
        startX: number;
        startY: number;
        triggered: boolean;
    };
    const pressStates = new Map<number, PressState>();

    function startPress(e: PointerEvent, welder: Welder) {
        if ((e instanceof PointerEvent) && e.button && e.button !== 0) return;
        const id = e.pointerId;
        const startX = (e as PointerEvent).clientX ?? 0;
        const startY = (e as PointerEvent).clientY ?? 0;
        if (pressStates.has(id)) clearPressState(id);
        const timeoutId = window.setTimeout(() => {
            const st = pressStates.get(id);
            if (st) st.triggered = true;
            handleWelderLongPress(welder);
        }, LONG_PRESS_MS);
        pressStates.set(id, { timeoutId, startX, startY, triggered: false });
        const target = e.target as Element | null;
        try { target?.setPointerCapture?.(id); } catch (err) { /* ignore */ }
    }

    function movePress(e: PointerEvent) {
        const id = e.pointerId;
        const st = pressStates.get(id);
        if (!st) return;
        const dx = Math.abs((e.clientX ?? 0) - st.startX);
        const dy = Math.abs((e.clientY ?? 0) - st.startY);
        if (dx > MOVE_CANCEL_PX || dy > MOVE_CANCEL_PX) {
            clearPressState(id);
        }
    }

    function endPress(e: PointerEvent) {
        const id = e.pointerId;
        const st = pressStates.get(id);
        if (!st) return;
        const hadTriggered = st.triggered;
        clearPressState(id);
        const target = e.target as Element | null;
        try { target?.releasePointerCapture?.(id); } catch (err) { /* ignore */ }
        if (hadTriggered) {
            (e.target as HTMLElement | null)?.addEventListener('click', stopImmediateOnce, { capture: true, once: true });
        }
    }

    function cancelPress(e: PointerEvent) {
        clearPressState(e.pointerId);
    }

    function clearPressState(pointerId: number) {
        const st = pressStates.get(pointerId);
        if (!st) return;
        if (st.timeoutId != null) clearTimeout(st.timeoutId);
        pressStates.delete(pointerId);
    }

    function stopImmediateOnce(ev: Event) {
        ev.stopImmediatePropagation();
        ev.preventDefault();
    }
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û ---

    // --- 4. –ù–û–í–û–ï: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º ---
    function handleWelderLongPress(welder: Welder) {
        selectedWelder = welder;
        showWelderModal = true;
    }

    function closeWelderModal() {
        showWelderModal = false;
        selectedWelder = null;
    }
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û ---

    onMount(() => {
        loadWelders();
    });
</script>

<!-- –í–µ—Å—å —ç–∫—Ä–∞–Ω —Ç–µ–ø–µ—Ä—å flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div class=\"app-container\">
    <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫ -->
    <header class=\"main-header\">
        <h1>–£—á—ë—Ç —Å–≤–∞—Ä—â–∏–∫–æ–≤</h1>
        <div class=\"controls\">
            <div class=\"add-welder\">
                <input
                    type=\"text\"
                    placeholder=\"–§–∞–º–∏–ª–∏—è —Å–≤–∞—Ä—â–∏–∫–∞\"
                    bind:value={newWelderName}
                    on:keydown={(e) => e.key === 'Enter' && addWelder()}
                />
                <button on:click={addWelder}>–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <ImportExport />
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ -->
    <main class=\"main-content\">
        <div class=\"welder-list\">
            {#each welders as welder (welder.id)}
                <!-- 5. –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ -->
                <a
                    href=\"{base}/welder/{welder.id}\"
                    class=\"welder-item\"
                    role=\"button\"
                    tabindex=\"0\"
                    on:pointerdown={(e) => startPress(e as PointerEvent, welder)}
                    on:pointermove={(e) => movePress(e as PointerEvent)}
                    on:pointerup={(e) => endPress(e as PointerEvent)}
                    on:pointercancel={(e) => cancelPress(e as PointerEvent)}
                    on:keydown={(e) => e.key === 'Enter' && handleWelderLongPress(welder)}
                >
                    {welder.name}
                </a>
            {/each}
        </div>
    </main>

    <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∏–∂–Ω–∏–π –±–ª–æ–∫ -->
    <footer class=\"main-footer\">
        <div class=\"nav-links\">
            <a href=\"{base}/plan\">–ü–ª–∞–Ω</a>
            <a href=\"{base}/norms\">–ù–æ—Ä–º—ã</a>
        </div>
    </footer>
</div>

<!-- 6. –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
<WelderCalendarModal bind:show={showWelderModal} welder={selectedWelder} on:close={closeWelderModal} />

<style>
    .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh; /* –ó–∞–Ω–∏–º–∞–µ–º –≤—Å—é –≤—ã—Å–æ—Ç—É —ç–∫—Ä–∞–Ω–∞ */
        max-width: 600px;
        margin: 0 auto;
        font-family: sans-serif;
        color: #333;
    }

    .main-header {
        flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
        padding: 1em;
        border-bottom: 1px solid #ccc; /* –°–¥–µ–ª–∞–ª–∏ –≥—Ä–∞–Ω–∏—Ü—É —á—É—Ç—å –º—è–≥—á–µ */
        background-color: #f0f4f8; /* –°–≤–µ—Ç–ª—ã–π —Å–∏–Ω–µ-—Å–µ—Ä—ã–π —Ñ–æ–Ω –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    }

    .main-header h1 {
        margin: 0 0 0.5em 0;
        color: #4a5568; /* –¢–µ–º–Ω—ã–π —Å–∏–Ω–µ-—Å–µ—Ä—ã–π –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
    }

    .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .add-welder {
        display: flex;
        gap: 8px;
    }

    input {
        padding: 8px;
        border: 1px solid #a0aec0; /* –ú—è–≥–∫–∏–π —Å–∏–Ω–µ-—Å–µ—Ä—ã–π –±–æ—Ä–¥–µ—Ä */
        border-radius: 4px;
        background-color: #fff;
    }

    button {
        padding: 8px 12px;
        border: none;
        background-color: #4299e1; /* –¢—Ä–µ–Ω–¥–æ–≤—ã–π steel blue –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease, box-shadow 0.2s ease; /* –ú—è–≥–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –±–µ–∑ —Ä–µ–∑–∫–æ—Å—Ç–∏ */
    }

    button:hover:not(:disabled) {
        background-color: #3182ce; /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ –¥–ª—è hover */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* –õ–µ–≥–∫–∞—è —Ç–µ–Ω—å –¥–ª—è –≥–ª—É–±–∏–Ω—ã */
    }

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ --- */
    .main-content {
        flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
        overflow-y: auto; /* –í–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ */
        padding: 1em;
        background-color: #edf2f7; /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Å–∏–Ω–µ-—Å–µ—Ä—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
    }

    .welder-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .welder-item {
        display: block;
        padding: 15px;
        background-color: #e2e8f0; /* –°–≤–µ—Ç–ª—ã–π —Å–∏–Ω–µ-—Å–µ—Ä—ã–π –¥–ª—è –ø–∞–Ω–µ–ª–µ–π */
        border: 1px solid #cbd5e0; /* –ú—è–≥–∫–∏–π –±–æ—Ä–¥–µ—Ä */
        border-radius: 5px;
        text-decoration: none;
        color: #2d3748; /* –¢–µ–º–Ω—ã–π —Å–∏–Ω–µ-—Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
        transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        /* 7. –ù–û–í–û–ï: –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        outline: none;
        touch-action: manipulation;
        /* --- –ö–û–ù–ï–¶ –ù–û–í–´–• –°–¢–ò–õ–ï–ô --- */
    }

    .welder-item:hover, .welder-item:focus {
        background-color: #cbd5e0; /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ –¥–ª—è hover */
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); /* –õ–µ–≥–∫–∞—è —Ç–µ–Ω—å –±–µ–∑ —Ä–µ–∑–∫–æ—Å—Ç–∏ */
    }

   /* --- –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–∞ --- */
    .main-footer {
        flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
        background-color: #4a5568; /* –¢–µ–º–Ω—ã–π —Å–∏–Ω–µ-—Å–µ—Ä—ã–π –¥–ª—è —Ñ—É—Ç–µ—Ä–∞ */
        padding: 1em;
        text-align: center;
        box-sizing: border-box;
    }

    .nav-links {
        display: flex;
        justify-content: center; /* –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        gap: 15px; /* –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
    }

    .main-footer a {
        color: white;
        text-decoration: none;
        font-weight: bold;
        padding: 10px 20px;
        border-radius: 5px;
        background-color: #4299e1; /* Steel blue –¥–ª—è —Å—Å—ã–ª–æ–∫ –≤ —Ñ—É—Ç–µ—Ä–µ */
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        /* –£–±–∏—Ä–∞–µ–º display: inline-block, —Ç–∞–∫ –∫–∞–∫ flex —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º */
    }

    .main-footer a:hover {
        background-color: #3182ce;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }   
</style>",
  "src/routes/welder/[id]/+page.svelte": "<script lang=\"ts\">
import { onMount } from 'svelte';
import { page } from '$app/stores';
import { db, type Welder, type Plan, type Record as DbRecord, type Norm, type DailyAllocation } from '$lib/db';
import { activatedDays as rawActivatedDays } from '$lib/stores';
import type { Writable } from 'svelte/store';
import { base } from '$app/paths';

// --- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ---
import RecordForm from '$lib/components/RecordForm.svelte';
import RecordList from '$lib/components/RecordList.svelte';
import RecordModal from '$lib/components/RecordModal.svelte';
// --- –ö–æ–Ω–µ—Ü –∏–º–ø–æ—Ä—Ç–∞ ---

// --- –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏–ø –¥–ª—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ ---
let activatedDays: Writable<string[]> = rawActivatedDays;
// --- –ö–û–ù–ï–¶ ---

// --- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
let welderId: number;
let welder: Welder | undefined;
let allPlans: Plan[] = [];
let records: DbRecord[] = [];

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
let newArticle = '';
let newQuantity = '';

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
let selectedRecord: DbRecord | null = null;
let selectedPlan: Plan | null = null;
let showModal = false;
// --- –ö–æ–Ω–µ—Ü —Å–æ—Å—Ç–æ—è–Ω–∏—è ---

// --- –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (reactive statements) ---
$: activePlans = allPlans.filter(p => p.isUnlimited || (p.quantity > 0 && p.completed < p.quantity));
// --- –ö–æ–Ω–µ—Ü –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π ---

// --- Simple per-welder mutex (to avoid race conditions when writing dailies) ---
const welderLocks = new Map<number, Promise<void>>();

function acquireWelderLock(id: number): Promise<() => void> {
\t// Create a new \"slot\" that will be resolved when this task is done
\tlet release!: () => void;
\tconst p = new Promise<void>((res) => (release = res));

\tconst prev = welderLocks.get(id) || Promise.resolve();
\t// Chain the new slot after previous
\twelderLocks.set(id, prev.then(() => p));

\t// Return a function that resolves the current slot
\treturn Promise.resolve(() => {
\t\trelease();
\t\t// If current slot is last, clean up map entry (best-effort)
\t\tconst cur = welderLocks.get(id);
\t\t// Note: can't easily compare Promises here for identity in all engines; leave map cleanup optional
\t});
}
// --- end mutex ---

// --- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ ---
async function loadData() {
\twelder = await db.welders.get(parseInt($page.params.id!, 10));
\tif (!welder) {
\t\tconsole.error('–°–≤–∞—Ä—â–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
\t\treturn;
\t}
\twelderId = welder.id!;
\tallPlans = await db.plans.toArray();
\trecords = await db.records.where('welderId').equals(welderId).reverse().sortBy('date');
}

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
function getDateString(date: Date): string {
\tconst year = date.getFullYear();
\tconst month = String(date.getMonth() + 1).padStart(2, '0');
\tconst day = String(date.getDate()).padStart(2, '0');
\treturn `${year}-${month}-${day}`;
}

function getMonthKey(date: Date): string {
\treturn `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
}

function nextWorkingDate(date: Date): Date {
\tlet next = new Date(date);
\tnext.setDate(next.getDate() + 1);
\twhile (next.getDay() === 0 || next.getDay() === 6) {
\t\tnext.setDate(next.getDate() + 1);
\t}
\treturn next;
}

// !!! FIX: —Å—á–∏—Ç–∞–µ–º –í–°–ï —á–∞—Å—ã —Å–≤–∞—Ä—â–∏–∫–∞ –Ω–∞ –¥–∞—Ç—É (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∞—Ä—Ç–∏–∫—É–ª–∞),
// —á—Ç–æ–±—ã —Å–æ–±–ª—é–¥–∞–ª—Å—è –ª–∏–º–∏—Ç 8 —á–∞—Å–æ–≤ –Ω–∞ —è—á–µ–π–∫—É.
async function getOccupiedHours(_article: string, dateStr: string): Promise<number> {
\t// –∏—Å–ø–æ–ª—å–∑—É–µ–º where –ø–æ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º—ã–º –ø–æ–ª—è–º ‚Äî –±—ã—Å—Ç—Ä–µ–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–µ–µ
\tconst dailies: DailyAllocation[] = await db.dailies
\t\t.where({ welderId, dateStr })
\t\t.toArray();
\treturn dailies.reduce((acc: number, d: DailyAllocation) => acc + d.hours, 0);
}

// –ü–æ–ª—É—á–∏—Ç—å map dateStr -> hours –¥–ª—è dailies, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞–ª–∏ –∑–∞–ø–∏—Å–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏)
async function getRecordDailiesMap(record: DbRecord): Promise<Record<string, number>> {
\tconst map: Record<string, number> = {};
\tconst recordDate = new Date(record.date);
\tconst recordMonthKey = getMonthKey(recordDate);

\tconst dailies: DailyAllocation[] = await db.dailies
\t\t.where('welderId')
\t\t.equals(welderId)
\t\t.filter((d: DailyAllocation) => {
\t\t\tconst dMonthKey = getMonthKey(new Date(d.dateStr));
\t\t\treturn d.article === record.article && dMonthKey === recordMonthKey;
\t\t})
\t\t.toArray();

\tfor (const d of dailies) {
\t\tmap[d.dateStr] = (map[d.dateStr] || 0) + d.hours;
\t}
\treturn map;
}

// --- –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ß–ê–°–û–í ---
// excludeMap: optional map dateStr -> hours (—á–∞—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã—á–µ—Å—Ç—å –∏–∑ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ë–î, –Ω–∞–ø—Ä–∏–º–µ—Ä —Å—Ç–∞—Ä—ã–µ dailies —ç—Ç–æ–π –∂–µ –∑–∞–ø–∏—Å–∏)
async function distributeHours(article: string, totalHours: number, excludeMap: Record<string, number> = {}): Promise<{ dateStr: string; hours: number }[]> {
\tlet hoursLeft = totalHours;
\tconst dailyDistribution: { dateStr: string; hours: number }[] = [];

\tconst priorityDates = [...$activatedDays].sort((a, b) => a.localeCompare(b));
\tconst priorityDatesSet = new Set(priorityDates);

\t// –ª–æ–∫–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ —É–∂–µ –≤—ã–¥–µ–ª—ë–Ω–Ω—ã—Ö –≤ —ç—Ç–æ–º –≤—ã–∑–æ–≤–µ —á–∞—Å–æ–≤ (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –æ–¥–Ω—É –¥–∞—Ç—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑)
\tconst allocatedSoFar: Record<string, number> = {};

\t// –≤—Å–ø–æ–º–æ–≥: –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –∑–∞–Ω—è—Ç–æ—Å—Ç—å —Å —É—á—ë—Ç–æ–º excludeMap –∏ allocatedSoFar
\tasync function getEffectiveOccupied(articleLocal: string, dateStr: string): Promise<number> {
\t\tconst dbOccupied = await getOccupiedHours(articleLocal, dateStr);
\t\tconst excluded = excludeMap[dateStr] || 0;
\t\tconst alreadyAllocated = allocatedSoFar[dateStr] || 0;
\t\t// effective = (–≤ –±–∞–∑–µ - —Ç–æ, —á—Ç–æ –º—ã –∏—Å–∫–ª—é—á–∞–µ–º) + —Ç–æ, —á—Ç–æ –º—ã —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
\t\tlet effective = dbOccupied - excluded + alreadyAllocated;
\t\tif (effective < 0) effective = 0;
\t\treturn effective;
\t}

\t// –®–ê–ì 1: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —è—á–µ–π–∫–∞–º
\tfor (const dateStr of priorityDates) {
\t\tif (hoursLeft <= 0.01) break;
\t\tconst occupied = await getEffectiveOccupied(article, dateStr);
\t\tconst free = Math.max(0, 8 - occupied);
\t\tif (free > 0) {
\t\t\tconst toAdd = Math.min(hoursLeft, free);
\t\t\tdailyDistribution.push({ dateStr, hours: toAdd });
\t\t\tallocatedSoFar[dateStr] = (allocatedSoFar[dateStr] || 0) + toAdd;
\t\t\thoursLeft -= toAdd;
\t\t}
\t}

\t// –®–ê–ì 2: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
\tlet currentDate = new Date();
\twhile (hoursLeft > 0.01) {
\t\tconst dayString = getDateString(currentDate);
\t\tif (priorityDatesSet.has(dayString)) {
\t\t\tcurrentDate = nextWorkingDate(currentDate);
\t\t\tcontinue;
\t\t}
\t\tconst isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
\t\tif (isWeekend) {
\t\t\tcurrentDate = nextWorkingDate(currentDate);
\t\t\tcontinue;
\t\t}
\t\tconst occupied = await getEffectiveOccupied(article, dayString);
\t\tconst free = Math.max(0, 8 - occupied);
\t\tif (free > 0) {
\t\t\tconst toAdd = Math.min(hoursLeft, free);
\t\t\tdailyDistribution.push({ dateStr: dayString, hours: toAdd });
\t\t\tallocatedSoFar[dayString] = (allocatedSoFar[dayString] || 0) + toAdd;
\t\t\thoursLeft -= toAdd;
\t\t}
\t\tcurrentDate = nextWorkingDate(currentDate);
\t}

\treturn dailyDistribution;
}

// --- –£–¥–∞–ª–µ–Ω–∏–µ dailies –¥–ª—è –∑–∞–ø–∏—Å–∏ ---
async function deleteDailiesForRecord(record: DbRecord) {
\tconst art = record.article;
\tconst recordDate = new Date(record.date);
\tconst recordMonthKey = getMonthKey(recordDate);

\tawait db.dailies
\t\t.where('welderId')
\t\t.equals(welderId)
\t\t.filter((d: DailyAllocation) => {
\t\t\tconst dMonthKey = getMonthKey(new Date(d.dateStr));
\t\t\treturn d.article === art && dMonthKey === recordMonthKey;
\t\t})
\t\t.delete();
}

// –¢—É–º–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π (toggle) ‚Äî –≤—ã–∑—ã–≤–∞–π –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø–æ –¥–æ–ª–≥–æ–º—É —Ç–∞–ø—É
function toggleActivatedDay(dateStr: string) {
\tactivatedDays.update(arr => {
\t\tconst idx = arr.indexOf(dateStr);
\t\tif (idx === -1) {
\t\t\treturn [...arr, dateStr].sort((a, b) => a.localeCompare(b));
\t\t} else {
\t\t\tconst next = arr.slice();
\t\t\tnext.splice(idx, 1);
\t\t\treturn next;
\t\t}
\t});
}

// 1. –ò–∑ RecordForm: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
async function handleAdd(event: CustomEvent<{ article: string; quantity: string | number }>) {
\ttry {
\t\tconst { article, quantity } = event.detail;
\t\tconst qty = parseFloat(String(quantity).replace(',', '.'));
\t\tif (article.trim() === '' || isNaN(qty) || qty <= 0) {
\t\t\talert('–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!');
\t\t\treturn;
\t\t}
\t\tconst activePlan = activePlans.find(p => p.article.toLowerCase() === article.trim().toLowerCase());
\t\tif (!activePlan) {
\t\t\talert('–¢–∞–∫–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞ –Ω–µ—Ç –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ø–ª–∞–Ω–µ –∏–ª–∏ –æ–Ω —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
\t\t\treturn;
\t\t}

\t\tif (!activePlan.isUnlimited && activePlan.completed + qty > activePlan.quantity) {
\t\t\talert(`–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å! –ü—Ä–µ–≤—ã—à–µ–Ω –ø–ª–∞–Ω –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É \"${activePlan.article}\". –û—Å—Ç–∞–ª–æ—Å—å ${(activePlan.quantity - activePlan.completed).toFixed(2).replace(/\\.?0+$/, '')}—à—Ç.`);
\t\t\treturn;
\t\t}

\t\tconst art = article.trim().toUpperCase();
\t\tconst norm = await db.norms.where('article').equals(art).first();
\t\tif (!norm) {
\t\t\talert(`–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–æ—Ä–º–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞—Ä—Ç–∏–∫—É–ª–∞ \"${art}\"!`);
\t\t\treturn;
\t\t}

\t\tconst totalHours = qty * norm.time;

\t\t// Acquire per-welder lock to avoid concurrent writes that can break the 8h limit
\t\tconst release = await acquireWelderLock(welderId);
\t\ttry {
\t\t\t// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ excludeMap –Ω–µ –Ω—É–∂–µ–Ω
\t\t\tconst dailyDistribution = await distributeHours(art, totalHours);

\t\t\t// –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
\t\t\tconst aggregatedQuantities = new Map<string, number>();
\t\t\tfor (const entry of dailyDistribution) {
\t\t\t\tconst date = new Date(entry.dateStr);
\t\t\t\tconst monthKey = getMonthKey(date);
\t\t\t\tconst quantityForDay = entry.hours / norm.time;
\t\t\t\taggregatedQuantities.set(monthKey, (aggregatedQuantities.get(monthKey) || 0) + quantityForDay);
\t\t\t}

\t\t\tawait db.transaction('rw', [db.records, db.plans, db.dailies], async () => {
\t\t\t\tfor (const entry of dailyDistribution) {
\t\t\t\t\tawait db.dailies.add({
\t\t\t\t\t\twelderId: welderId,
\t\t\t\t\t\tarticle: art,
\t\t\t\t\t\tdateStr: entry.dateStr,
\t\t\t\t\t\thours: entry.hours
\t\t\t\t\t});
\t\t\t\t}

\t\t\t\tfor (const [monthKey, quantity] of aggregatedQuantities.entries()) {
\t\t\t\t\tconst [year, month] = monthKey.split('-').map(Number);
\t\t\t\t\tconst recordDate = new Date(year, month - 1, 1);

\t\t\t\t\tconst existingRecord = await db.records
\t\t\t\t\t\t.where({ welderId, article: art })
\t\t\t\t\t\t.and(r => {
\t\t\t\t\t\t\tconst rDate = new Date(r.date);
\t\t\t\t\t\t\treturn rDate.getFullYear() === year && rDate.getMonth() === month - 1;
\t\t\t\t\t\t})
\t\t\t\t\t\t.first();

\t\t\t\t\tconst historyEntry = { date: new Date().toISOString(), quantity: quantity, note: `–î–æ–±–∞–≤–ª–µ–Ω–æ ${quantity.toFixed(2)} —à—Ç` };
\t\t\t\t\tif (existingRecord) {
\t\t\t\t\t\tconst newTotalQuantity = existingRecord.quantity + quantity;
\t\t\t\t\t\tconst newHistory = [...JSON.parse(existingRecord.history || '[]'), historyEntry];
\t\t\t\t\t\tawait db.records.update(existingRecord.id!, { quantity: newTotalQuantity, history: JSON.stringify(newHistory) });
\t\t\t\t\t} else {
\t\t\t\t\t\tawait db.records.add({
\t\t\t\t\t\t\twelderId: welderId,
\t\t\t\t\t\t\tarticle: art,
\t\t\t\t\t\t\tquantity: quantity,
\t\t\t\t\t\t\tdate: recordDate,
\t\t\t\t\t\t\thistory: JSON.stringify([historyEntry])
\t\t\t\t\t\t});
\t\t\t\t\t}
\t\t\t\t}

\t\t\t\tactivePlan.completed += qty;
\t\t\t\tawait db.plans.update(activePlan.id!, { completed: activePlan.completed });
\t\t\t});
\t\t} finally {
\t\t\t// release lock
\t\t\trelease();
\t\t}

\t\t// –ù–ï –æ—á–∏—â–∞–µ–º activatedDays ‚Äî —á—Ç–æ–±—ã –≤—ã–±–æ—Ä —è—á–µ–µ–∫ —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è –º–µ–∂–¥—É –≤–≤–æ–¥–∞–º–∏
\t\tnewArticle = '';
\t\tnewQuantity = '';
\t\tawait loadData();

\t} catch (error) {
\t\tconsole.error(\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏:\", error);
\t\talert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞! –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12).`);
\t}
}

// 2. –ò–∑ RecordList: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω—É–ª –Ω–∞ –∞—Ä—Ç–∏–∫—É–ª
function handleSelectArticle(event: CustomEvent<{ article: string }>) {
\tnewArticle = event.detail.article;
\tdocument.getElementById('quantity-input')?.focus();
}

// 3. –ò–∑ RecordList: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–≥–æ –Ω–∞–∂–∞–ª –Ω–∞ –∑–∞–ø–∏—Å—å
function handleOpenModal(event: CustomEvent<{ record: DbRecord }>) {
\tselectedRecord = event.detail.record;
\tselectedPlan = allPlans.find(p => p.article === selectedRecord!.article) || null;
\tshowModal = true;
}

// 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏
async function handleSave(event: CustomEvent<{ newQuantity: number; quantityDifference: number }>) {
\tif (!selectedRecord || !selectedPlan) return;

\tconst record = selectedRecord;
\tconst plan = selectedPlan;
\tconst { newQuantity, quantityDifference } = event.detail;

\ttry {
\t\tconst art = record.article;
\t\tconst norm = await db.norms.where('article').equals(art).first();
\t\tif (!norm) {
\t\t\talert(`–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–æ—Ä–º–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞—Ä—Ç–∏–∫—É–ª–∞ \"${art}\"!`);
\t\t\treturn;
\t\t}

\t\tconst oldQuantity = record.quantity;
\t\tconst totalHours = newQuantity * norm.time;

\t\t// --- –ù–û–í–û–ï: —Å–Ω–∞—á–∞–ª–∞ —Å—á–∏—Ç—ã–≤–∞–µ–º, –∫–∞–∫–∏–µ dailies –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞–ª–∏ —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏ (map date->hours)
\t\tconst recordOwnMap = await getRecordDailiesMap(record);

\t\t// –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ dailies (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
\t\tawait deleteDailiesForRecord(record);

\t\t// Acquire per-welder lock to avoid race conditions while redistributing and writing
\t\tconst release = await acquireWelderLock(welderId);
\t\ttry {
\t\t\t// –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–µ —á–∞—Å—ã, –ø–µ—Ä–µ–¥–∞–≤–∞—è excludeMap = recordOwnMap,
\t\t\t// —á—Ç–æ–±—ã distributeHours \"–∑–Ω–∞–ª\", –∫–∞–∫–∏–µ —á–∞—Å—ã –±—ã–ª–∏ –Ω–∞—à–∏–º–∏ –∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª –∏—Ö –¥–≤–∞–∂–¥—ã.
\t\t\tconst dailyDistribution = await distributeHours(art, totalHours, recordOwnMap);

\t\t\tawait db.transaction('rw', [db.records, db.plans, db.dailies], async () => {
\t\t\t\t// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ dailies
\t\t\t\tfor (const entry of dailyDistribution) {
\t\t\t\t\tawait db.dailies.add({
\t\t\t\t\t\twelderId: welderId,
\t\t\t\t\t\tarticle: art,
\t\t\t\t\t\tdateStr: entry.dateStr,
\t\t\t\t\t\thours: entry.hours
\t\t\t\t\t});
\t\t\t\t}

\t\t\t\t// –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
\t\t\t\tconst historyEntry = {
\t\t\t\t\tdate: new Date().toISOString(),
\t\t\t\t\tquantity: quantityDifference,
\t\t\t\t\tnote: `–ò–∑–º–µ–Ω–µ–Ω–æ —Å ${oldQuantity.toFixed(2).replace(/\\.?0+$/, '')} –Ω–∞ ${newQuantity.toFixed(2).replace(/\\.?0+$/, '')}`
\t\t\t\t};
\t\t\t\tconst newHistory = [...JSON.parse(record.history || '[]'), historyEntry];
\t\t\t\tawait db.records.update(record.id!, {
\t\t\t\t\tquantity: newQuantity,
\t\t\t\t\tdate: record.date,
\t\t\t\t\thistory: JSON.stringify(newHistory)
\t\t\t\t});

\t\t\t\t// –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–∞–Ω
\t\t\t\tplan.completed += quantityDifference;
\t\t\t\tawait db.plans.update(plan.id!, { completed: plan.completed });
\t\t\t});
\t\t} finally {
\t\t\trelease();
\t\t}

\t\t// –ù–ï –æ—á–∏—â–∞–µ–º activatedDays ‚Äî —á—Ç–æ–±—ã –≤—ã–±–æ—Ä —è—á–µ–µ–∫ —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è –º–µ–∂–¥—É –ø—Ä–∞–≤–∫–∞–º–∏
\t\tcloseModal();
\t\tawait loadData();

\t} catch (error) {
\t\tconsole.error(\"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:\", error);
\t\talert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞! –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12).`);
\t}
}

// 5. –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
async function handleDelete() {
\tif (!selectedRecord || !selectedPlan) return;

\tconst record = selectedRecord;
\tconst plan = selectedPlan;

\ttry {
\t\t// –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ dailies
\t\tawait deleteDailiesForRecord(record);

\t\tawait db.transaction('rw', db.records, db.plans, async () => {
\t\t\tawait db.records.delete(record.id!);
\t\t\tplan.completed -= record.quantity;
\t\t\tif (plan.completed < 0) plan.completed = 0;
\t\t\tawait db.plans.update(plan.id!, { completed: plan.completed });
\t\t});

\t\tcloseModal();
\t\tawait loadData();
\t} catch (error) {
\t\tconsole.error(\"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:\", error);
\t\talert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞! –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12).`);
\t}
}

// 6. –ò–∑ RecordModal: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª –æ–∫–Ω–æ
function closeModal() {
\tshowModal = false;
\tselectedRecord = null;
\tselectedPlan = null;
}
// --- –ö–æ–Ω–µ—Ü –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ---

onMount(() => {
\tloadData();
});
</script>


<main>
{#if welder}
<h1>–ö–∞—Ä—Ç–æ—á–∫–∞ —Å–≤–∞—Ä—â–∏–∫–∞: {welder.name}</h1>
{:else}
<h1>–°–≤–∞—Ä—â–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</h1>
{/if}

<!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ñ–æ—Ä–º—ã -->
<RecordForm
  {activePlans}
  bind:newArticle
  bind:newQuantity
  on:add={handleAdd}
/>

<!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ -->
<RecordList
  {records}
  {allPlans}
  on:selectArticle={handleSelectArticle}
  on:openModal={handleOpenModal}
/>

<!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
<RecordModal
  bind:show={showModal}
  selectedRecord={selectedRecord}
  plan={selectedPlan}
  on:save={handleSave}
  on:delete={handleDelete}
  on:close={closeModal}
/>

<!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ \"–¥–æ–º–æ–π ‚àÜ\" -->
<div class=\"bottom-nav\">
<a href=\"{base}/\">–¥–æ–º–æ–π ‚àÜ</a>
</div>
</main>

<style>
main {
\tfont-family: sans-serif;
\ttext-align: center;
\tpadding: 1em;
\tmax-width: 600px;
\tmargin: 0 auto;
\tcolor: #333;
\tpadding-bottom: 80px;
}

h1 {
\tcolor: #444;
\tborder-bottom: 2px solid #eee;
\tpadding-bottom: 10px;
\tmargin-bottom: 20px;
}

.bottom-nav {
\tposition: fixed;
\tbottom: 0;
\tleft: 0;
\twidth: 100%;
\tbackground-color: #444;
\tpadding: 1em;
\ttext-align: center;
\tbox-sizing: border-box;
}

.bottom-nav a {
\tcolor: white;
\ttext-decoration: none;
\tfont-weight: bold;
\tpadding: 10px 20px;
\tborder-radius: 5px;
\tbackground-color: #555;
\ttransition: background-color 0.2s;
}

.bottom-nav a:hover {
\tbackground-color: #666;
}
</style>",
  "src/routes/plan/+page.svelte": "<script lang=\"ts\">
    import { onMount } from 'svelte';
    import { base } from '$app/paths';
    import { db, type Plan, type Norm } from '$lib/db'; // <-- –î–û–ë–ê–í–ò–õ–ò type Norm

    // --- –ù–û–í–û–ï: –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ ---
    let allNorms: Norm[] = [];
    let showSuggestions = false;
    let suggestions: Norm[] = [];
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û ---

    function formatQuantity(num: number): string {
        return num.toFixed(2).replace(/\\.?0+$/, '');
    }

    let plans: Plan[] = [];
    let newArticle = '';
    let newQuantity = '';

    let showPlanModal = false;
    let selectedPlan: Plan | null = null;
    let editArticle = '';
    let editQuantity = '';

    async function loadPlans() {
        plans = await db.plans.orderBy('id').reverse().toArray();
    }

    // --- –ù–û–í–û–ï: –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º ---
    async function loadNorms() {
        allNorms = await db.norms.orderBy('article').toArray();
    }
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ï ---

    async function addPlan() {
        const quantity = parseInt(newQuantity, 10);
        if (newArticle.trim() === '' || isNaN(quantity) || quantity < 0) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!');
            return;
        }

        const isUnlimited = quantity === 0;

        await db.plans.add({
            article: newArticle.trim().toUpperCase(),
            quantity: quantity,
            completed: 0,
            isUnlimited: isUnlimited
        });

        newArticle = '';
        newQuantity = '';
        await loadPlans();
    }

    // --- LONG PRESS IMPLEMENTATION (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    const LONG_PRESS_MS = 2000;
    const MOVE_CANCEL_PX = 10;
    type PressState = { timeoutId: number | null; startX: number; startY: number; triggered: boolean; };
    const pressStates = new Map<number, PressState>();

    function startPress(e: PointerEvent, plan: Plan) {
        if ((e instanceof PointerEvent) && e.button && e.button !== 0) return;
        const id = e.pointerId;
        const startX = (e as PointerEvent).clientX ?? 0;
        const startY = (e as PointerEvent).clientY ?? 0;
        if (pressStates.has(id)) { clearPressState(id); }
        const timeoutId = window.setTimeout(() => {
            const st = pressStates.get(id); if (st) { st.triggered = true; } handlePlanLongPress(plan);
        }, LONG_PRESS_MS);
        pressStates.set(id, { timeoutId, startX, startY, triggered: false });
        const target = e.target as Element | null;
        try { target?.setPointerCapture?.(id); } catch (err) { /* ignore */ }
    }

    function movePress(e: PointerEvent) {
        const id = e.pointerId; const st = pressStates.get(id);
        if (!st) return;
        const dx = Math.abs((e.clientX ?? 0) - st.startX);
        const dy = Math.abs((e.clientY ?? 0) - st.startY);
        if (dx > MOVE_CANCEL_PX || dy > MOVE_CANCEL_PX) { clearPressState(id); }
    }

    function endPress(e: PointerEvent) {
        const id = e.pointerId; const st = pressStates.get(id);
        if (!st) return;
        const hadTriggered = st.triggered;
        clearPressState(id);
        const target = e.target as Element | null;
        try { target?.releasePointerCapture?.(id); } catch (err) { /* ignore */ }
        if (hadTriggered) {
            (e.target as HTMLElement | null)?.addEventListener('click', stopImmediateOnce, { capture: true, once: true });
        }
    }

    function cancelPress(e: PointerEvent) { clearPressState(e.pointerId); }
    function clearPressState(pointerId: number) {
        const st = pressStates.get(pointerId);
        if (!st) return;
        if (st.timeoutId != null) { clearTimeout(st.timeoutId); }
        pressStates.delete(pointerId);
    }
    function stopImmediateOnce(ev: Event) { ev.stopImmediatePropagation(); ev.preventDefault(); }
    // --- END LONG PRESS ---

    // –ú–æ–¥–∞–ª–∫–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è
    function handlePlanLongPress(plan: Plan) {
        selectedPlan = plan;
        showPlanModal = true;
    }

    function openEditPlan() {
        if (selectedPlan) {
            editArticle = selectedPlan.article;
            editQuantity = selectedPlan.quantity.toString();
        }
    }

    function openCompletePlan() {
        if (selectedPlan && !selectedPlan.isUnlimited) {
            if (confirm(`–û—Ç–º–µ—Ç–∏—Ç—å –ø–ª–∞–Ω \"${selectedPlan.article}\" –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π?`)) {
                savePlanChanges({ completed: selectedPlan.quantity });
            }
        } else {
            alert(\"–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –ø–ª–∞–Ω –Ω–µ–ª—å–∑—è –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º.\");
        }
    }

    async function deletePlan() {
        if (!selectedPlan) return;
        if (selectedPlan.completed > 0) {
            alert(\"–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–ª–∞–Ω, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É —É–∂–µ –µ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã!\");
            return;
        }
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–ª–∞–Ω \"${selectedPlan.article}\"?`)) {
            await db.plans.delete(selectedPlan.id!);
            closePlanModal();
            await loadPlans();
        }
    }

    async function savePlanChanges(changes: Partial<Plan>) {
        if (!selectedPlan) return;
        try {
            await db.plans.update(selectedPlan.id!, changes);
            closePlanModal();
            await loadPlans();
        } catch (error) {
            console.error(\"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞:\", error);
            alert(\"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.\");
        }
    }

    function closePlanModal() {
        showPlanModal = false;
        selectedPlan = null;
        editArticle = '';
        editQuantity = '';
    }

    // --- –ù–û–í–û–ï: –†–µ–∞–∫—Ç–∏–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ ---
    $: if (newArticle.trim() !== '') {
        suggestions = allNorms.filter(norm =>
            norm.article.toLowerCase().includes(newArticle.toLowerCase())
        );
        showSuggestions = suggestions.length > 0;
    } else {
        suggestions = [];
        showSuggestions = false;
    }

    function selectSuggestion(article: string) {
        newArticle = article;
        showSuggestions = false;
        document.getElementById('quantity-input')?.focus();
    }
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û ---

    onMount(() => {
        loadPlans();
        loadNorms(); // <-- –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ—Ä–º—ã –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    });
</script>

<main>
    <h1>–ü–ª–∞–Ω —Ä–∞–±–æ—Ç</h1>

    <div class=\"add-plan\">
        <!-- –ù–û–í–û–ï: –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∏–Ω–ø—É—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ -->
        <div class=\"input-with-suggestions\">
            <input
                type=\"text\"
                placeholder=\"–ê—Ä—Ç–∏–∫—É–ª\"
                bind:value={newArticle}
                on:focus={() => showSuggestions = newArticle.trim() !== ''}
            />
            {#if showSuggestions}
                <div class=\"suggestions-list\">
                    {#each suggestions as suggestion (suggestion.id)}
                       <button class=\"suggestion-item\" on:click={() => selectSuggestion(suggestion.article)}>
                           <span class=\"suggestion-article\">{suggestion.article}</span>
                           <span class=\"suggestion-info\">{suggestion.time}—á</span>
                      </button>
                    {/each}
                </div>
            {/if}
        </div>
        <!-- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û -->

        <input
            id=\"quantity-input\"
            type=\"number\"
            placeholder=\"–ö–æ–ª-–≤–æ\"
            bind:value={newQuantity}
            on:keydown={(e) => e.key === 'Enter' && addPlan()}
        />
        <button on:click={addPlan}>–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class=\"plan-list\">
        {#each plans as plan (plan.id)}
            <div
                class=\"plan-item\"
                class:completed={plan.quantity > 0 && plan.completed >= plan.quantity}
                role=\"button\"
                tabindex=\"0\"
                on:pointerdown={(e) => startPress(e as PointerEvent, plan)}
                on:pointermove={(e) => movePress(e as PointerEvent)}
                on:pointerup={(e) => endPress(e as PointerEvent)}
                on:pointercancel={(e) => cancelPress(e as PointerEvent)}
                on:keydown={(e) => e.key === 'Enter' && handlePlanLongPress(plan)}
            >
                <span class=\"article\">{plan.article}</span>
                <span class=\"quantity\">{formatQuantity(plan.quantity)}—à—Ç</span>
                <span class=\"progress\">... {formatQuantity(plan.completed)}—à—Ç</span>
            </div>
        {/each}
    </div>

    {#if showPlanModal && selectedPlan}
        <div class=\"modal-overlay\" on:click={closePlanModal}>
            <div class=\"modal-content\" on:click|stopPropagation>
                <h3>–î–µ–π—Å—Ç–≤–∏—è —Å –ø–ª–∞–Ω–æ–º: {selectedPlan.article}</h3>

                <div class=\"edit-section\">
                    <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:</h4>
                    <input type=\"text\" placeholder=\"–ê—Ä—Ç–∏–∫—É–ª\" bind:value={editArticle} />
                    <input type=\"number\" placeholder=\"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ\" bind:value={editQuantity} />
                    <button class=\"save-button\" on:click={() => savePlanChanges({ article: editArticle.trim().toUpperCase(), quantity: parseInt(editQuantity, 10) })}>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>

                <div class=\"modal-actions\">
                    <button class=\"complete-button\" on:click={openCompletePlan} disabled={selectedPlan.isUnlimited}>
                        ‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º
                    </button>
                    <button class=\"delete-button\" on:click={deletePlan}>
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                    <button class=\"cancel-button\" on:click={closePlanModal}>–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    {/if}

    <div class=\"bottom-nav\">
        <a href=\"{base}/\">–¥–æ–º–æ–π ‚àÜ</a>
    </div>
</main>

<style>
    main {
        font-family: sans-serif;
        text-align: center;
        padding: 1em;
        max-width: 600px;
        margin: 0 auto;
        color: #333;
        padding-bottom: 80px;
    }

    .add-plan {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 2em;
        flex-wrap: wrap;
    }

    input {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        max-width: 150px;
    }

    button {
        padding: 8px 12px;
        border: none;
        background-color: #555;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    button:hover:not(:disabled) {
        background-color: #777;
    }

    button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .plan-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .plan-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: #f4f4f4;
        border: 1px solid #ddd;
        border-radius: 5px;
        transition: border-color 0.3s, background-color 0.3s;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        outline: none;
        touch-action: manipulation;
    }

    .plan-item:hover, .plan-item:focus {
        background-color: #e8e8e8;
    }

    .plan-item.completed {
        border-color: #4caf50;
        background-color: #e8f5e9;
    }

    .article {
        font-weight: bold;
    }

    .quantity {
        color: #555;
    }

    .progress {
        color: #777;
        font-style: italic;
    }

    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #444;
        padding: 1em;
        text-align: center;
        box-sizing: border-box;
    }

    .bottom-nav a {
        color: white;
        text-decoration: none;
        font-weight: bold;
        padding: 10px 20px;
        border-radius: 5px;
        background-color: #555;
        transition: background-color 0.2s;
    }

    .bottom-nav a:hover {
        background-color: #666;
    }

    /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ü–û–î–°–ö–ê–ó–û–ö --- */
    .input-with-suggestions {
        position: relative;
    }

    .suggestions-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 10;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .suggestion-item {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        cursor: pointer;
        width: 100%;
        background: none;
        border: none;
        text-align: left;
    }

    .suggestion-item:hover {
        background-color: #f0f0f0;
    }

    .suggestion-article {
        font-weight: bold;
        color: #333;
    }

    .suggestion-info {
        color: #888;
        font-size: 0.9em;
    }
    /* --- –ö–û–ù–ï–¶ –ù–û–í–´–• –°–¢–ò–õ–ï–ô --- */

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-width: 400px;
        width: 90%;
        text-align: left;
    }

    .modal-content h3 {
        margin-top: 0;
        text-align: center;
    }

    .edit-section {
        margin: 20px 0;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
        border: 1px solid #eee;
    }

    .edit-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
    }

    .edit-section input {
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 10px;
    }

    .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
    }

    .complete-button {
        background-color: #5cb85c;
    }

    .complete-button:hover:not(:disabled) {
        background-color: #4cae4c;
    }

    .delete-button {
        background-color: #d9534f;
    }

    .delete-button:hover {
        background-color: #c9302c;
    }

    .cancel-button {
        background-color: #777;
    }

    .cancel-button:hover {
        background-color: #555;
    }

    .save-button {
        background-color: #337ab7;
        width: 100%;
        margin-top: 10px;
    }

    .save-button:hover {
        background-color: #286090;
    }
</style>",
  "src/routes/norms/+page.svelte": "<script lang=\"ts\">
    import { onMount } from 'svelte';
    import { base } from '$app/paths';
    import { db, type Norm } from '$lib/db';

    let norms: Norm[] = [];
    let newArticle = '';
    let newTime = '';

    let showNormModal = false;
    let selectedNorm: Norm | null = null;
    let editArticle = '';
    let editTime = '';

    async function loadNorms() {
        norms = await db.norms.orderBy('article').toArray();
    }

    async function addNorm() {
        const time = parseFloat(newTime);
        if (newArticle.trim() === '' || isNaN(time) || time <= 0) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è!');
            return;
        }

        await db.norms.add({
            article: newArticle.trim().toUpperCase(),
            time: time
        });

        newArticle = '';
        newTime = '';
        await loadNorms();
    }

    // --- LONG PRESS IMPLEMENTATION (—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å —ç–∫—Ä–∞–Ω–∞ –ü–ª–∞–Ω) ---
    const LONG_PRESS_MS = 500;
    const MOVE_CANCEL_PX = 10;

    type PressState = {
        timeoutId: number | null;
        startX: number;
        startY: number;
        triggered: boolean;
    };
    const pressStates = new Map<number, PressState>();

    function startPress(e: PointerEvent, norm: Norm) {
        if ((e instanceof PointerEvent) && e.button && e.button !== 0) return;
        const id = e.pointerId;
        const startX = (e as PointerEvent).clientX ?? 0;
        const startY = (e as PointerEvent).clientY ?? 0;
        if (pressStates.has(id)) clearPressState(id);
        const timeoutId = window.setTimeout(() => {
            const st = pressStates.get(id);
            if (st) st.triggered = true;
            handleNormLongPress(norm);
        }, LONG_PRESS_MS);
        pressStates.set(id, { timeoutId, startX, startY, triggered: false });
        const target = e.target as Element | null;
        try { target?.setPointerCapture?.(id); } catch (err) { /* ignore */ }
    }

    function movePress(e: PointerEvent) {
        const id = e.pointerId;
        const st = pressStates.get(id);
        if (!st) return;
        const dx = Math.abs((e.clientX ?? 0) - st.startX);
        const dy = Math.abs((e.clientY ?? 0) - st.startY);
        if (dx > MOVE_CANCEL_PX || dy > MOVE_CANCEL_PX) {
            clearPressState(id);
        }
    }

    function endPress(e: PointerEvent) {
        const id = e.pointerId;
        const st = pressStates.get(id);
        if (!st) return;
        const hadTriggered = st.triggered;
        clearPressState(id);
        const target = e.target as Element | null;
        try { target?.releasePointerCapture?.(id); } catch (err) { /* ignore */ }
        if (hadTriggered) {
            (e.target as HTMLElement | null)?.addEventListener('click', stopImmediateOnce, { capture: true, once: true });
        }
    }

    function cancelPress(e: PointerEvent) {
        clearPressState(e.pointerId);
    }

    function clearPressState(pointerId: number) {
        const st = pressStates.get(pointerId);
        if (!st) return;
        if (st.timeoutId != null) clearTimeout(st.timeoutId);
        pressStates.delete(pointerId);
    }

    function stopImmediateOnce(ev: Event) {
        ev.stopImmediatePropagation();
        ev.preventDefault();
    }
    // --- END LONG PRESS ---

    // –ú–æ–¥–∞–ª–∫–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è
    function handleNormLongPress(norm: Norm) {
        selectedNorm = norm;
        showNormModal = true;
    }

    function openEditNorm() {
        if (selectedNorm) {
            editArticle = selectedNorm.article;
            editTime = selectedNorm.time.toString();
        }
    }

    async function deleteNorm() {
        if (!selectedNorm) return;
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –Ω–æ—Ä–º—É \"${selectedNorm.article}\"?`)) {
            await db.norms.delete(selectedNorm.id!);
            closeNormModal();
            await loadNorms();
        }
    }

    async function saveNormChanges(changes: Partial<Norm>) {
        if (!selectedNorm) return;
        try {
            await db.norms.update(selectedNorm.id!, changes);
            closeNormModal();
            await loadNorms();
        } catch (error) {
            console.error(\"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–æ—Ä–º—ã:\", error);
            alert(\"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.\");
        }
    }

    function closeNormModal() {
        showNormModal = false;
        selectedNorm = null;
        editArticle = '';
        editTime = '';
    }

    onMount(() => {
        loadNorms();
    });
</script>

<main>
    <h1>–ù–æ—Ä–º—ã –≤—Ä–µ–º–µ–Ω–∏</h1>

    <div class=\"add-norm\">
        <input
            type=\"text\"
            placeholder=\"–ê—Ä—Ç–∏–∫—É–ª\"
            bind:value={newArticle}
            on:keydown={(e) => {
                if (e.key === 'Enter') {
                    document.getElementById('time-input')?.focus();
                }
            }}
        />
        <input
            id=\"time-input\"
            type=\"number\"
            step=\"0.1\"
            placeholder=\"–í—Ä–µ–º—è (—á)\"
            bind:value={newTime}
            on:keydown={(e) => e.key === 'Enter' && addNorm()}
        />
        <button on:click={addNorm}>–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class=\"norm-list\">
        {#each norms as norm (norm.id)}
            <div
                class=\"norm-item\"
                role=\"button\"
                tabindex=\"0\"
                on:pointerdown={(e) => startPress(e as PointerEvent, norm)}
                on:pointermove={(e) => movePress(e as PointerEvent)}
                on:pointerup={(e) => endPress(e as PointerEvent)}
                on:pointercancel={(e) => cancelPress(e as PointerEvent)}
                on:keydown={(e) => e.key === 'Enter' && handleNormLongPress(norm)}
            >
                <span class=\"article\">{norm.article}</span>
                <span class=\"time\">{norm.time}—á</span>
            </div>
        {/each}
    </div>

    {#if showNormModal && selectedNorm}
        <div class=\"modal-overlay\" on:click={closeNormModal}>
            <div class=\"modal-content\" on:click|stopPropagation>
                <h3>–î–µ–π—Å—Ç–≤–∏—è —Å –Ω–æ—Ä–º–æ–π: {selectedNorm.article}</h3>

                <div class=\"edit-section\">
                    <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:</h4>
                    <input type=\"text\" placeholder=\"–ê—Ä—Ç–∏–∫—É–ª\" bind:value={editArticle} />
                    <input type=\"number\" step=\"0.1\" placeholder=\"–í—Ä–µ–º—è (—á)\" bind:value={editTime} />
                    <button class=\"save-button\" on:click={() => saveNormChanges({ article: editArticle.trim().toUpperCase(), time: parseFloat(editTime) })}>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>

                <div class=\"modal-actions\">
                    <button class=\"delete-button\" on:click={deleteNorm}>
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                    <button class=\"cancel-button\" on:click={closeNormModal}>–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    {/if}

    <div class=\"bottom-nav\">
        <a href=\"{base}/\">–¥–æ–º–æ–π ‚àÜ</a>
    </div>
</main>

<style>
    main {
        font-family: sans-serif;
        text-align: center;
        padding: 1em;
        max-width: 600px;
        margin: 0 auto;
        color: #333;
        padding-bottom: 80px; /* –ú–µ—Å—Ç–æ –¥–ª—è –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    }

    .add-norm {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 2em;
        flex-wrap: wrap;
    }

    input {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        max-width: 150px;
    }

    button {
        padding: 8px 12px;
        border: none;
        background-color: #555;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    button:hover:not(:disabled) {
        background-color: #777;
    }

    .norm-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .norm-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: #f4f4f4;
        border: 1px solid #ddd;
        border-radius: 5px;
        transition: border-color 0.3s, background-color 0.3s;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        outline: none;
        touch-action: manipulation;
    }

    .norm-item:hover, .norm-item:focus {
        background-color: #e8e8e8;
    }

    .article {
        font-weight: bold;
    }

    .time {
        color: #555;
    }

    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #444;
        padding: 1em;
        text-align: center;
        box-sizing: border-box;
    }

    .bottom-nav a {
        color: white;
        text-decoration: none;
        font-weight: bold;
        padding: 10px 20px;
        border-radius: 5px;
        background-color: #555;
        transition: background-color 0.2s;
    }

    .bottom-nav a:hover {
        background-color: #666;
    }

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-width: 400px;
        width: 90%;
        text-align: left;
    }

    .modal-content h3 {
        margin-top: 0;
        text-align: center;
    }

    .edit-section {
        margin: 20px 0;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
        border: 1px solid #eee;
    }

    .edit-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
    }

    .edit-section input {
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 10px;
    }

    .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
    }

    .delete-button {
        background-color: #d9534f;
    }

    .delete-button:hover {
        background-color: #c9302c;
    }

    .cancel-button {
        background-color: #777;
    }

    .cancel-button:hover {
        background-color: #555;
    }

    .save-button {
        background-color: #337ab7;
        width: 100%;
        margin-top: 10px;
    }

    .save-button:hover {
        background-color: #286090;
    }
</style>",
  "src/lib/db.ts": "import Dexie, { type Table } from 'dexie';

export interface Welder {
id?: number;
name: string;
}

export interface Plan {
id?: number;
article: string;
quantity: number;
completed: number;
isUnlimited: boolean;
}

export interface Record {
id?: number;
welderId: number;
article: string;
quantity: number;
date: Date;
history: string;
}

// --- –ù–û–í–û–ï: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã \"–ù–æ—Ä–º—ã\" ---
export interface Norm {
id?: number;
article: string; // –ê—Ä—Ç–∏–∫—É–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä \"–•–¢637\"
time: number; // –ù–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è –≤ —á–∞—Å–∞—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä 10
}
// --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û ---

// --- –ù–û–í–û–ï: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å—É—Ç–æ—á–Ω—ã—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π ---
export interface DailyAllocation {
id?: number;
welderId: number;
article: string;
dateStr: string; // 'YYYY-MM-DD'
hours: number;
}
// --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û ---

export class MyDatabase extends Dexie {
welders!: Table<Welder>;
plans!: Table<Plan>;
records!: Table<Record>;
norms!: Table<Norm>;
dailies!: Table<DailyAllocation>;

constructor() {
super('MyDatabase');
// --- –ò–ó–ú–ï–ù–ï–ù–û: –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é –¥–æ 3 –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É dailies ---
this.version(3).stores({
welders: '++id, name',
plans: '++id, article, quantity, completed, isUnlimited', 
records: '++id, welderId, article, quantity, date, history',
norms: '++id, article, time',
dailies: '++id, welderId, article, dateStr, hours'
});
// --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

// --- –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–±—ã—Ç–∏–µ 'ready' –¥–ª—è –ø–æ—Å—Ç-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ---
// –≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–µ–Ω –∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å —Ç–∏–ø–∞–º–∏ –≤ TypeScript
this.on('ready', () => {
console.log(\"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω–æ—Ä–º—ã...\");
this.populateNorms();
});
// --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
}

// --- –ù–û–í–û–ï: –ú–µ—Ç–æ–¥ –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –Ω–æ—Ä–º ---
async populateNorms() {
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–æ—Ä–º
const normCount = await this.norms.count();
if (normCount === 0) {
console.log('–¢–∞–±–ª–∏—Ü–∞ \"–ù–æ—Ä–º—ã\" –ø—É—Å—Ç–∞, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...');
// –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–æ—Ç –º–∞—Å—Å–∏–≤ –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
const initialNorms = [
{ article: '–•–¢637', time: 10 },
{ article: '–•–¢55', time: 12 },
{ article: '–•–¢52', time: 8 },
{ article: '–ê–†–¢123', time: 5.5 },
{ article: '–ê–†–¢456', time: 15 }
];
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
await this.transaction('rw', this.norms, async () => {
await this.norms.bulkAdd(initialNorms);
});
console.log('–¢–∞–±–ª–∏—Ü–∞ \"–ù–æ—Ä–º—ã\" –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.');
} else {
console.log(`–¢–∞–±–ª–∏—Ü–∞ \"–ù–æ—Ä–º—ã\" —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç ${normCount} –∑–∞–ø–∏—Å–µ–π.`);
}
}
// --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û ---
}

export const db = new MyDatabase();",
  "src/lib/components/ImportExport.svelte": "<script lang=\"ts\">
    import { db, type Welder, type Plan, type Record } from '$lib/db';

    // --- –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö (–æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    async function handleExport() {
        try {
            const welders = await db.welders.toArray();
            const plans = await db.plans.toArray();
            const records = await db.records.toArray();

            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                data: { welders, plans, records }
            };

            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const today = new Date().toISOString().split('T')[0];
            a.download = `welding_data_${today}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12).');
        }
        console.log('>>> –ù–∞—á–∏–Ω–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Ç–∞–±–ª–∏—Ü—ã records...');
            const records_via_toArray = await db.records.toArray();
            const records_via_query = await db.records.where('id').above(0).toArray(); // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –≤—Å—ë

            console.log('>>> –†–µ–∑—É–ª—å—Ç–∞—Ç db.records.toArray():', records_via_toArray);
            console.log('>>> –†–µ–∑—É–ª—å—Ç–∞—Ç db.records.where(...).toArray():', records_via_query);
            console.log('>>> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã?', JSON.stringify(records_via_toArray) === JSON.stringify(records_via_query));
            // --- –ö–û–ù–ï–¶ –¢–ï–°–¢–ê ---

            const records = records_via_toArray; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç toArray –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    }

    // --- –ù–û–í–û–ï: –ü–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ ---
    let fileInput: HTMLInputElement;

    function triggerImport() {
        fileInput.click();
    }

    async function handleFileSelect(event: Event) {
        const target = event.target as HTMLInputElement;
        const file = target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const jsonString = e.target?.result as string;
                const importData = JSON.parse(jsonString);

                if (!importData.data) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–µ–∫—Ü–∏—è data.');
                }

                // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
                await db.transaction('rw', db.welders, db.plans, db.records, async () => {
                    // --- 1. –ò–º–ø–æ—Ä—Ç —Å–≤–∞—Ä—â–∏–∫–æ–≤ ---
                    const welderNameToIdMap = new Map<string, number>();
                    const existingWelders = await db.welders.toArray();
                    existingWelders.forEach(w => welderNameToIdMap.set(w.name, w.id!));

                    let addedWelders = 0;
                    for (const welder of importData.data.welders) {
                        if (!welderNameToIdMap.has(welder.name)) {
                            const id = await db.welders.add(welder);
                            welderNameToIdMap.set(welder.name, id);
                            addedWelders++;
                        }
                    }

                    // --- 2. –ò–º–ø–æ—Ä—Ç –ø–ª–∞–Ω–æ–≤ ---
                    const planArticleToIdMap = new Map<string, number>();
                    const existingPlans = await db.plans.toArray();
                    existingPlans.forEach(p => planArticleToIdMap.set(p.article, p.id!));

                    let addedPlans = 0;
                    for (const plan of importData.data.plans) {
                        if (!planArticleToIdMap.has(plan.article)) {
                            const id = await db.plans.add(plan);
                            planArticleToIdMap.set(plan.article, id);
                            addedPlans++;
                        }
                    }

                    // --- 3. –ò–º–ø–æ—Ä—Ç –∑–∞–ø–∏—Å–µ–π (—Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å) ---
                    let addedRecords = 0;
                    for (const record of importData.data.records) {
                        const welderId = welderNameToIdMap.get(record.welderName); // –í —Ñ–∞–π–ª–µ –º—ã –∏—â–µ–º –ø–æ –∏–º–µ–Ω–∏
                        const planId = planArticleToIdMap.get(record.article);

                        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–ø–∏—Å—å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –∏ —Å–≤–∞—Ä—â–∏–∫, –∏ –ø–ª–∞–Ω
                        if (welderId && planId) {
                            await db.records.add({
                                ...record, // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—è (quantity, date, history)
                                welderId,  // –ó–∞–º–µ–Ω—è–µ–º ID –Ω–∞ –Ω–∞—à, –ª–æ–∫–∞–ª—å–Ω—ã–π
                            });
                            addedRecords++;
                        }
                    }
                    
                                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –ø–ª–∞–Ω–∞—Ö –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
                    const allPlans = await db.plans.toArray();
                    for(const plan of allPlans) {
                        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
                        const recordsForPlan = await db.records.where('article').equals(plan.article).toArray();
                        const totalCompleted = recordsForPlan.reduce((sum, record) => sum + record.quantity, 0);
                        await db.plans.update(plan.id!, { completed: totalCompleted });
                    }

                    alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\\n\\n–î–æ–±–∞–≤–ª–µ–Ω–æ:\\n- –°–≤–∞—Ä—â–∏–∫–æ–≤: ${addedWelders}\\n- –ü–ª–∞–Ω–æ–≤: ${addedPlans}\\n- –ó–∞–ø–∏—Å–µ–π: ${addedRecords}`);
                });

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: ${error instanceof Error ? error.message : String(error)}`);
            } finally {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ input, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å–Ω–æ–≤–∞
                target.value = '';
            }
        };

        reader.onerror = () => {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.');
        };

        reader.readAsText(file);
    }
</script>

<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ -->
<input bind:this={fileInput} type=\"file\" accept=\".json\" on:change={handleFileSelect} style=\"display: none;\" />

<div class=\"import-export-controls\">
    <button class=\"export-button\" on:click={handleExport}>
    ‚û°Ô∏è –≠–∫—Å–ø–æ—Ä—Ç
    </button>
    <button class=\"import-button\" on:click={triggerImport}>
    ‚¨ÖÔ∏è –ò–º–ø–æ—Ä—Ç
    </button>
</div>

<style>
    .import-export-controls {
        display: flex;
        gap: 10px;
    }

    .import-export-controls button {
        padding: 8px 12px;
        border: none;
        background-color: #555;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        font-weight: bold;
    }

    .import-export-controls button:hover {
        background-color: #777;
        transform: translateY(-1px);
    }

    .import-export-controls button:active {
        transform: translateY(0);
    }

    .export-button {
        background-color: #5cb85c;
    }

    .export-button:hover {
        background-color: #4cae4c;
    }

    .import-button {
        background-color: #f0ad4e;
    }

    .import-button:hover {
        background-color: #ec971f;
    }
</style>",
  "src/lib/components/RecordForm.svelte": "<script lang=\"ts\">
    import { createEventDispatcher } from 'svelte';
    import type { Plan } from '$lib/db';

    // --- Props (—Å–≤–æ–π—Å—Ç–≤–∞), –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–¥–∞—Å—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ---
    export let activePlans: Plan[] = [];
    export let newArticle: string;
    export let newQuantity: string;
    // --- –ö–æ–Ω–µ—Ü Props ---

    const dispatch = createEventDispatcher();

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞) ---
    let showSuggestions = false;
    let suggestions: Plan[] = [];

    function formatQuantity(num: number): string {
        return num.toFixed(2).replace(/\\.?0+$/, '');
    }

    $: if (newArticle.trim() !== '') {
        suggestions = activePlans.filter(plan =>
            plan.article.toLowerCase().includes(newArticle.toLowerCase())
        );
        showSuggestions = suggestions.length > 0;
    } else {
        suggestions = [];
        showSuggestions = false;
    }

    function selectSuggestion(article: string) {
        newArticle = article;
        showSuggestions = false;
        // –§–æ–∫—É—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ –ø–æ–ª–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        document.getElementById('quantity-input')?.focus();
    }

    // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–æ–±—â–∏—Ç —Ä–æ–¥–∏—Ç–µ–ª—é –æ –ø–æ–ø—ã—Ç–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function handleAdd() {
        dispatch('add', {
            article: newArticle,
            quantity: newQuantity
        });
    }
</script>

<div class=\"add-record\">
    <div class=\"input-with-suggestions\">
        <input
            type=\"text\"
            placeholder=\"–ê—Ä—Ç–∏–∫—É–ª\"
            bind:value={newArticle}
            on:focus={() => showSuggestions = newArticle.trim() !== ''}
        />
        {#if showSuggestions}
            <div class=\"suggestions-list\">
                {#each suggestions as suggestion (suggestion.id)}
                   <button class=\"suggestion-item\" on:click={() => selectSuggestion(suggestion.article)}>
                       <span class=\"suggestion-article\">{suggestion.article}</span>
                       <span class=\"suggestion-info\">{formatQuantity(suggestion.completed)}/{formatQuantity(suggestion.quantity)}—à—Ç</span>
                  </button>
                {/each}
            </div>
        {/if}
    </div>

    <input
        id=\"quantity-input\"
        type=\"number\"
        step=\"0.01\"
        placeholder=\"–ö–æ–ª-–≤–æ\"
        bind:value={newQuantity}
        on:keydown={(e) => e.key === 'Enter' && handleAdd()}
    />
    <button on:click={handleAdd}>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
</div>

<style>
    .add-record {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 2em;
        flex-wrap: wrap;
    }

    .input-with-suggestions {
        position: relative;
    }

    input {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        max-width: 150px;
    }

    .suggestions-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 10;
    }

    .suggestion-item {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        cursor: pointer;
        width: 100%;
        background: none;
        border: none;
        text-align: left;
    }

    .suggestion-item:hover {
        background-color: #f0f0f0;
    }

    .suggestion-article {
        font-weight: bold;
        color: #333;
    }

    .suggestion-info {
        color: #888;
        font-size: 0.9em;
    }

    button {
        padding: 8px 12px;
        border: none;
        background-color: #555;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    button:hover {
        background-color: #777;
    }
    .touch-friendly {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }

</style>",
  "src/lib/components/RecordList.svelte": "<script lang=\"ts\">
    import { createEventDispatcher } from 'svelte';
    import type { Record, Plan } from '$lib/db';

    // --- Props ---
    export let records: Record[] = [];
    export let allPlans: Plan[] = [];
    // --- –ö–æ–Ω–µ—Ü Props ---

    const dispatch = createEventDispatcher();

    // --- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏-–ø–æ–º–æ—â–Ω–∏–∫–∏ ---
    function formatQuantity(num: number): string {
        return num.toFixed(2).replace(/\\.?0+$/, '');
    }

    function groupRecordsByMonth(records: Record[] | undefined) {
        if (!records || records.length === 0) {
            return new Map();
        }
        const grouped = new Map<string, Record[]>();
        for (const record of records) {
            const date = new Date(record.date);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!grouped.has(monthKey)) {
                grouped.set(monthKey, []);
            }
            grouped.get(monthKey)!.push(record);
        }
        return grouped;
    }

    $: groupedRecords = groupRecordsByMonth(records);

    function getUnitForRecord(record: Record): string {
        const plan = allPlans.find(p => p.article === record.article);
        return (plan && plan.isUnlimited) ? '—á' : '—à—Ç';
    }

    // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –ö–õ–ò–ö–û–í –ò –î–û–õ–ì–û–ì–û –ù–ê–ñ–ê–¢–ò–Ø ---
    let pressTimer: number;

    function handlePointerDown(event: PointerEvent, record: Record) {
        // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å—á–µ—Ç –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
        pressTimer = window.setTimeout(() => {
            // –ï—Å–ª–∏ –∑–∞ 500–º—Å –Ω–µ –±—ã–ª–æ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è, —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –¥–æ–ª–≥–∏–º –Ω–∞–∂–∞—Ç–∏–µ–º
            handleLongPress(record);
        }, 500);
    }

    function handlePointerUp(event: PointerEvent, record: Record) {
        // –û—Ç–ø—É—Å—Ç–∏–ª–∏ –ø–∞–ª–µ—Ü/–º—ã—à—å
        clearTimeout(pressTimer); // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∂–∞—Ç–∏–µ (–Ω–µ –±—ã–ª–æ –¥–æ–ª–≥–æ–≥–æ)
        // –∏ —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –±—ã–ª–æ –ª–µ–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –º—ã—à–∏ –∏–ª–∏ –∫–∞—Å–∞–Ω–∏–µ–º –ø–∞–ª—å—Ü–∞
        if (event.button === 0 || event.pointerType === 'touch') {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ-–∞—Ä—Ç–∏–∫—É–ª—É
            const target = event.target as HTMLElement;
            if (target.closest('.article-button')) {
                handleArticleClick(record.article);
            }
        }
    }

    function handlePointerCancel() {
        // –ï—Å–ª–∏ –∂–µ—Å—Ç –ø—Ä–µ—Ä–≤–∞–ª—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª —Å–∫—Ä–æ–ª–ª–∏—Ç—å)
        clearTimeout(pressTimer);
    }
    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –õ–û–ì–ò–ö–ò ---


    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å —Ä–æ–¥–∏—Ç–µ–ª–µ–º ---
    function handleArticleClick(article: string) {
        dispatch('selectArticle', { article });
    }

    function handleLongPress(record: Record) {
        dispatch('openModal', { record });
    }
    // --- –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–π –æ–±—â–µ–Ω–∏—è ---
</script>

<div class=\"record-list\">
    <h2>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h2>
    {#each Array.from(groupedRecords.entries()) as [monthKey, monthRecords] (monthKey)}
        <div class=\"month-block\">
            <h3 class=\"month-header\">{new Date(monthKey + '-01').toLocaleDateString('ru-RU', { year: 'numeric', month: 'long' })}</h3>
            {#each monthRecords as record (record.id)}
                <div
                    class=\"record-item\"
                    role=\"button\"
                    tabindex=\"0\"
                    on:pointerdown={(e) => handlePointerDown(e, record)}
                    on:pointerup={(e) => handlePointerUp(e, record)}
                    on:pointercancel={handlePointerCancel}
                    on:keydown={(e) => e.key === 'Enter' && handleLongPress(record)}
                >
                    <button class=\"article-button\">{record.article}</button>
                    <span class=\"quantity\">{formatQuantity(record.quantity)}{getUnitForRecord(record)}</span>
                    <span class=\"date\">{new Date(record.date).toLocaleDateString('ru-RU')}</span>
                </div>
            {/each}
        </div>
    {/each}
</div>

<style>
    .record-list h2 {
        text-align: left;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }

    .month-block {
        margin-top: 1.5em;
    }

    .month-header {
        text-align: left;
        font-size: 1.1em;
        color: #555;
        border-bottom: 2px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 10px;
    }

    .record-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í --- */
        user-select: none; /* –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
        -webkit-tap-highlight-color: transparent; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ —Ç–∞–ø–µ */
        outline: none;
        touch-action: manipulation; /* –û—Ç–∫–ª—é—á–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –Ω–∞ –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø */
        /* --- –ö–û–ù–ï–¶ –ù–û–í–´–• –°–¢–ò–õ–ï–ô --- */
    }

    .record-item:hover, .record-item:focus {
        background-color: #f9f9f9;
    }

    .article-button {
        font-weight: bold;
        flex-grow: 1;
        text-align: left;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        transition: background-color 0.2s;
        color: #333;
    }

    .article-button:hover {
        background-color: #e0e0e0;
    }

    .quantity {
        color: #555;
        margin-right: 15px;
    }

    .date {
        color: #999;
        font-size: 0.9em;
    }
</style>",
  "src/lib/components/RecordModal.svelte": "<script lang=\"ts\">
    import { createEventDispatcher, onMount } from 'svelte';
    import type { Record, Plan } from '$lib/db';

    // --- Props ---
    export let selectedRecord: Record | null = null;
    export let plan: Plan | null = null;
    export let show: boolean = false;
    // --- –ö–æ–Ω–µ—Ü Props ---

    const dispatch = createEventDispatcher();
    let editQuantity = '';

    // –†–µ–∞–∫—Ç–∏–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞, –∫–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
    $: if (selectedRecord) {
        editQuantity = selectedRecord.quantity.toString();
    }

    // --- –ù–û–í–û–ï: –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏ \"–±—ã–ª–æ -> —Å—Ç–∞–ª–æ\" ---
    $: historyChanges = calculateHistory(selectedRecord);

    function calculateHistory(record: Record | null) {
        if (!record || !record.history) return [];

        const history = JSON.parse(record.history);
        const changes = [];
        let currentQuantity = 0;

        for (const entry of history) {
            const was = currentQuantity;
            const became = currentQuantity + entry.quantity;
            changes.push({
                date: new Date(entry.date),
                was: was,
                became: became,
                note: entry.note || ''
            });
            currentQuantity = became;
        }
        return changes.reverse(); // –ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤–µ—Ä—Ö—É
    }
    // --- –ö–û–ù–ï–¶ –õ–û–ì–ò–ö–ò ---

    function formatQuantity(num: number): string {
        return num.toFixed(2).replace(/\\.?0+$/, '');
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å —Ä–æ–¥–∏—Ç–µ–ª–µ–º ---
    function handleSave() {
        if (!selectedRecord || !plan) return;

                const newQuantity = parseFloat(String(editQuantity).replace(',', '.'));
        if (isNaN(newQuantity) || newQuantity < 0) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!');
            return;
        }

        const quantityDifference = newQuantity - selectedRecord.quantity;
        const newTotalForArticle = plan.completed + quantityDifference;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ø–ª–∞–Ω–∞
        if (newTotalForArticle > plan.quantity) {
            alert(`–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å! –ò—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (${formatQuantity(newTotalForArticle)}—à—Ç) –ø—Ä–µ–≤—ã—Å–∏—Ç –ø–ª–∞–Ω (${formatQuantity(plan.quantity)}—à—Ç).`);
            return;
        }

        dispatch('save', { newQuantity, quantityDifference });
    }

    function handleDelete() {
        if (!selectedRecord) return;
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å \"${selectedRecord.article}\"?`)) {
            dispatch('delete');
        }
    }

    function handleClose() {
        dispatch('close');
    }
    // --- –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–π –æ–±—â–µ–Ω–∏—è ---
</script>

{#if show && selectedRecord && plan}
    <div class=\"modal-overlay\" role=\"button\" tabindex=\"0\" on:click={handleClose} on:keydown={(e) => e.key === 'Enter' && handleClose()}>
        <div class=\"modal-content\" role=\"dialog\" aria-labelledby=\"modal-title\" tabindex=\"-1\" on:click|stopPropagation on:keydown={(e) => e.key === 'Escape' && handleClose()}>
            <h3 id=\"modal-title\">–ó–∞–ø–∏—Å—å: {selectedRecord.article}</h3>

            <!-- –ë–ª–æ–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ -->
            <div class=\"edit-section\">
                <label for=\"edit-quantity-input\">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                <input id=\"edit-quantity-input\" type=\"number\" step=\"0.01\" bind:value={editQuantity} />
            </div>

            <!-- –ë–ª–æ–∫ —Å –∏—Å—Ç–æ—Ä–∏–µ–π -->
            <div class=\"history-section\">
                <h4>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:</h4>
                <div class=\"history-list\">
                    {#each historyChanges as change (change.date.toISOString())}
                        <div class=\"history-item\">
                            <span class=\"history-date\">{change.date.toLocaleDateString('ru-RU')}</span>
                            <span class=\"history-change\">
                                {formatQuantity(change.was)}—à—Ç --‚ñ∫ {formatQuantity(change.became)}—à—Ç
                                {#if change.note}
                                    <span class=\"history-note\">({change.note})</span>
                                {/if}
                            </span>
                        </div>
                    {/each}
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class=\"modal-actions\">
                <button class=\"save-button\" on:click={handleSave}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class=\"delete-button\" on:click={handleDelete}>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                <button class=\"cancel-button\" on:click={handleClose}>–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
{/if}

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        outline: none;
    }

    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-width: 450px;
        width: 90%;
        text-align: left;
    }

    .modal-content h3 {
        margin-top: 0;
        text-align: center;
        color: #333;
    }

    .edit-section {
        margin: 20px 0;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
        border: 1px solid #eee;
    }

    .edit-section label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .edit-section input {
        width: 100%;
        box-sizing: border-box;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .history-section {
        margin-top: 20px;
    }

    .history-section h4 {
        margin-bottom: 10px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }

    .history-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #eee;
        padding: 10px;
        background-color: #fafafa;
    }

    .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.9em;
    }

    .history-item:last-child {
        border-bottom: none;
    }

    .history-date {
        font-weight: bold;
        color: #555;
        flex-shrink: 0;
        margin-right: 10px;
    }

    .history-change {
        color: #333;
    }

    .history-note {
        color: #888;
        font-style: italic;
    }

    .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
    }

    .save-button {
        background-color: #5cb85c;
    }

    .save-button:hover {
        background-color: #4cae4c;
    }

    .delete-button {
        background-color: #d9534f;
    }

    .delete-button:hover {
        background-color: #c9302c;
    }

    .cancel-button {
        background-color: #777;
    }

    .cancel-button:hover {
        background-color: #555;
    }

    button {
        padding: 10px 12px;
        border: none;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-weight: bold;
    }
</style>"
}
